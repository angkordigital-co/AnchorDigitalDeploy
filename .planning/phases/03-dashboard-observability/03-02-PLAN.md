---
phase: 03-dashboard-observability
plan: 03-02
name: sites-list-deployments
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - dashboard/app/(dashboard)/page.tsx
  - dashboard/app/(dashboard)/sites/page.tsx
  - dashboard/app/(dashboard)/sites/[siteId]/page.tsx
  - dashboard/app/(dashboard)/sites/[siteId]/deployments/page.tsx
  - dashboard/app/(dashboard)/sites/[siteId]/deployments/actions.ts
  - dashboard/lib/aws/dynamodb.ts
  - dashboard/components/tables/sites-table.tsx
  - dashboard/components/tables/deployments-table.tsx
autonomous: true
requirements: [DASH-02, DASH-03, DASH-06]

must_haves:
  truths:
    - "User can see list of all their connected sites on dashboard home"
    - "User can view deployment history for a specific site"
    - "User can trigger rollback to a previous deployment from UI"
    - "Rollback success/failure shown to user"
  artifacts:
    - path: "dashboard/app/(dashboard)/sites/page.tsx"
      provides: "Sites list page"
    - path: "dashboard/app/(dashboard)/sites/[siteId]/deployments/page.tsx"
      provides: "Deployment history page with rollback button"
    - path: "dashboard/lib/aws/dynamodb.ts"
      provides: "DynamoDB query functions for projects and deployments"
      exports: ["getUserProjects", "getProjectDeployments"]
    - path: "dashboard/components/tables/sites-table.tsx"
      provides: "TanStack Table for sites list"
    - path: "dashboard/components/tables/deployments-table.tsx"
      provides: "TanStack Table for deployments with rollback action"
  key_links:
    - from: "dashboard/app/(dashboard)/sites/page.tsx"
      to: "dashboard/lib/aws/dynamodb.ts"
      via: "getUserProjects server call"
      pattern: "getUserProjects"
    - from: "dashboard/components/tables/deployments-table.tsx"
      to: "dashboard/app/(dashboard)/sites/[siteId]/deployments/actions.ts"
      via: "rollback server action"
      pattern: "triggerRollback"
---

<objective>
Build sites list and deployment history pages with rollback functionality.

Purpose: Users need to see all their deployed sites at a glance and manage deployment history, including the ability to instantly rollback to previous versions when issues arise.

Output: Sites list on dashboard home, deployment history table per site, working rollback button that calls existing API.
</objective>

<execution_context>
@/Users/myownip/.config/claude/get-shit-done/workflows/execute-plan.md
@/Users/myownip/.config/claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03-dashboard-observability/03-RESEARCH.md
@.planning/phases/03-dashboard-observability/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DynamoDB Query Functions and Install TanStack Table</name>
  <files>
    dashboard/lib/aws/dynamodb.ts
    dashboard/lib/aws/types.ts
    dashboard/package.json
  </files>
  <action>
    1. Install TanStack Table and date-fns:
       ```bash
       cd /Users/myownip/workspace/vercel-clone/dashboard
       npm install @tanstack/react-table date-fns
       ```

    2. Install shadcn/ui table component:
       ```bash
       npx shadcn@latest add table badge dropdown-menu
       ```

    3. Create dashboard/lib/aws/types.ts with TypeScript interfaces:
       ```typescript
       export interface Project {
         projectId: string;
         userId: string;
         name: string;
         repoUrl: string;
         createdAt: string;
         updatedAt: string;
       }

       export interface Deployment {
         deploymentId: string;
         projectId: string;
         status: 'pending' | 'building' | 'built' | 'deploying' | 'success' | 'failed';
         commitHash: string;
         commitMessage?: string;
         createdAt: string;
         completedAt?: string;
       }
       ```

    4. Create dashboard/lib/aws/dynamodb.ts:
       ```typescript
       import { DynamoDBClient } from '@aws-sdk/client-dynamodb';
       import { DynamoDBDocumentClient, QueryCommand } from '@aws-sdk/lib-dynamodb';

       const client = new DynamoDBClient({ region: process.env.AWS_REGION });
       const dynamodb = DynamoDBDocumentClient.from(client);

       export async function getUserProjects(userId: string): Promise<Project[]> {
         const command = new QueryCommand({
           TableName: process.env.PROJECTS_TABLE_NAME,
           IndexName: 'UserIdIndex',
           KeyConditionExpression: 'userId = :userId',
           ExpressionAttributeValues: { ':userId': userId },
         });
         const result = await dynamodb.send(command);
         return (result.Items || []) as Project[];
       }

       export async function getProjectDeployments(projectId: string): Promise<Deployment[]> {
         const command = new QueryCommand({
           TableName: process.env.DEPLOYMENTS_TABLE_NAME,
           IndexName: 'ProjectIdIndex',
           KeyConditionExpression: 'projectId = :projectId',
           ExpressionAttributeValues: { ':projectId': projectId },
           ScanIndexForward: false, // Most recent first
           Limit: 50,
         });
         const result = await dynamodb.send(command);
         return (result.Items || []) as Deployment[];
       }
       ```

    5. Add to dashboard/.env.local:
       ```
       PROJECTS_TABLE_NAME=anchor-deploy-dev-ProjectsTable-cwdhxuwt
       DEPLOYMENTS_TABLE_NAME=anchor-deploy-dev-DeploymentsTable-sdhkosws
       ```
  </action>
  <verify>
    TypeScript compilation passes: `cd dashboard && npx tsc --noEmit`
  </verify>
  <done>DynamoDB query functions exist with proper types, TanStack Table installed.</done>
</task>

<task type="auto">
  <name>Task 2: Build Sites List Page with TanStack Table</name>
  <files>
    dashboard/app/(dashboard)/page.tsx
    dashboard/app/(dashboard)/sites/page.tsx
    dashboard/components/tables/sites-table.tsx
    dashboard/components/ui/data-table.tsx
  </files>
  <action>
    1. Create dashboard/components/ui/data-table.tsx - reusable TanStack Table wrapper:
       - Accept columns and data props
       - Render shadcn/ui Table component
       - Support sorting and filtering (basic)
       - Follow shadcn/ui data-table pattern from docs

    2. Create dashboard/components/tables/sites-table.tsx:
       - Define columns: Name (link to /sites/[siteId]), Repo URL, Last Deployed, Status
       - Name column links to /sites/{projectId}
       - Status shows badge with latest deployment status
       - Format dates with date-fns formatDistanceToNow

    3. Create dashboard/app/(dashboard)/sites/page.tsx (Server Component):
       ```typescript
       import { auth } from '@/lib/auth';
       import { getUserProjects } from '@/lib/aws/dynamodb';
       import { SitesTable } from '@/components/tables/sites-table';
       import { redirect } from 'next/navigation';

       export default async function SitesPage() {
         const session = await auth();
         if (!session?.user?.id) redirect('/login');

         const projects = await getUserProjects(session.user.id);

         return (
           <div className="p-6">
             <h1 className="text-2xl font-bold mb-6">Your Sites</h1>
             <SitesTable data={projects} />
           </div>
         );
       }
       ```

    4. Update dashboard/app/(dashboard)/page.tsx to redirect to /sites:
       ```typescript
       import { redirect } from 'next/navigation';
       export default function DashboardHome() {
         redirect('/sites');
       }
       ```
  </action>
  <verify>
    1. Visit http://localhost:3000 after login
    2. Should redirect to /sites
    3. Sites table displays (may be empty if no projects in DynamoDB)
    4. Click site name navigates to /sites/[siteId]
  </verify>
  <done>Sites list page shows all user projects in a sortable table with links to site details.</done>
</task>

<task type="auto">
  <name>Task 3: Build Deployment History Page with Rollback</name>
  <files>
    dashboard/app/(dashboard)/sites/[siteId]/page.tsx
    dashboard/app/(dashboard)/sites/[siteId]/layout.tsx
    dashboard/app/(dashboard)/sites/[siteId]/deployments/page.tsx
    dashboard/app/(dashboard)/sites/[siteId]/deployments/actions.ts
    dashboard/components/tables/deployments-table.tsx
    dashboard/components/dashboard/site-nav.tsx
  </files>
  <action>
    1. Create dashboard/components/dashboard/site-nav.tsx:
       - Sub-navigation for site pages: Overview, Deployments, Logs, Metrics, Env, Domains
       - Highlight active route
       - Horizontal tabs or vertical list

    2. Create dashboard/app/(dashboard)/sites/[siteId]/layout.tsx:
       - Fetch project details from DynamoDB
       - Verify user owns this project (project.userId === session.user.id)
       - Return 404 if not found or not owned
       - Render site name as heading + SiteNav

    3. Create dashboard/app/(dashboard)/sites/[siteId]/page.tsx:
       - Redirect to /sites/[siteId]/deployments (or show overview with stats)

    4. Create dashboard/components/tables/deployments-table.tsx:
       - Columns: Deployment ID (short), Status (badge), Commit (7 chars), Message, Deployed At, Actions
       - Actions dropdown: View Logs, Rollback (only for successful deployments)
       - Use shadcn/ui DropdownMenu for actions
       - Rollback calls server action

    5. Create dashboard/app/(dashboard)/sites/[siteId]/deployments/actions.ts:
       ```typescript
       'use server';

       import { auth } from '@/lib/auth';
       import { revalidatePath } from 'next/cache';

       export async function triggerRollback(projectId: string, deploymentId: string) {
         const session = await auth();
         if (!session?.user?.id) throw new Error('Unauthorized');

         // Call existing rollback API
         const response = await fetch(
           `${process.env.API_GATEWAY_URL}/projects/${projectId}/rollback`,
           {
             method: 'POST',
             headers: {
               'Content-Type': 'application/json',
               'x-user-id': session.user.id,
             },
             body: JSON.stringify({ deploymentId }),
           }
         );

         if (!response.ok) {
           const error = await response.json();
           throw new Error(error.message || 'Rollback failed');
         }

         revalidatePath(`/sites/${projectId}/deployments`);
         return { success: true };
       }
       ```

    6. Create dashboard/app/(dashboard)/sites/[siteId]/deployments/page.tsx:
       - Fetch deployments with getProjectDeployments
       - Render DeploymentsTable
       - Show empty state if no deployments

    7. Configure API Gateway URL from SST resource binding:
       - In sst.config.ts, link the API Gateway URL to the dashboard Next.js app (will be set up in Plan 03-01)
       - The dashboard accesses it via `Resource.WebhookApi.url` using @sst/sdk
       - For local development, add to dashboard/.env.local:
         ```
         API_GATEWAY_URL=https://ksha1s4pnc.execute-api.ap-southeast-1.amazonaws.com
         ```
       - In production, the SST resource binding provides this automatically
  </action>
  <verify>
    1. Navigate to /sites/[siteId]/deployments
    2. See deployment history in table
    3. Click Rollback on a successful deployment
    4. Verify rollback API called (check Lambda logs or API response)
    5. Table refreshes after rollback
  </verify>
  <done>Deployment history page shows all deployments with status, rollback button triggers API and refreshes UI.</done>
</task>

</tasks>

<verification>
1. `cd dashboard && npm run build` - builds without errors
2. Login and navigate to /sites - see sites table
3. Click a site - navigate to /sites/[siteId]/deployments
4. Deployment history shows with columns: ID, Status, Commit, Message, Time, Actions
5. Click Rollback on a 'success' deployment - API called, table refreshes
6. Site nav tabs work (Deployments active, others link to placeholder pages)
</verification>

<success_criteria>
- Sites list page at /sites shows all user's projects
- TanStack Table with sorting for sites
- Deployment history at /sites/[siteId]/deployments
- Rollback button visible on successful deployments
- Rollback calls POST /projects/{projectId}/rollback API
- UI shows success/error feedback after rollback
- Page revalidates after rollback
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard-observability/03-02-SUMMARY.md`
</output>
