---
phase: 03-dashboard-observability
plan: 03-01
name: dashboard-foundation-auth
type: execute
wave: 1
depends_on: []
files_modified:
  - dashboard/package.json
  - dashboard/app/layout.tsx
  - dashboard/app/(auth)/login/page.tsx
  - dashboard/lib/auth.ts
  - dashboard/middleware.ts
  - dashboard/components/ui/*
  - dashboard/components/dashboard/sidebar.tsx
  - dashboard/components/dashboard/header.tsx
  - infra/stacks/database.ts
autonomous: true
requirements: [DASH-01]

must_haves:
  truths:
    - "User can access /login page without authentication"
    - "User can log in with email/password credentials"
    - "Unauthenticated users are redirected to /login when accessing dashboard routes"
    - "Authenticated users see dashboard layout with sidebar and header"
  artifacts:
    - path: "dashboard/package.json"
      provides: "Next.js 15 app with Auth.js v5, shadcn/ui, AWS SDK v3"
    - path: "dashboard/lib/auth.ts"
      provides: "Auth.js v5 configuration with DynamoDB credentials provider"
      exports: ["auth", "signIn", "signOut", "handlers"]
    - path: "dashboard/middleware.ts"
      provides: "Route protection middleware"
    - path: "dashboard/app/(auth)/login/page.tsx"
      provides: "Login form with credentials"
    - path: "dashboard/components/dashboard/sidebar.tsx"
      provides: "Dashboard sidebar navigation"
    - path: "infra/stacks/database.ts"
      provides: "UsersTable with email GSI"
      contains: "UsersTable"
  key_links:
    - from: "dashboard/middleware.ts"
      to: "dashboard/lib/auth.ts"
      via: "auth() import"
      pattern: "import.*auth.*from.*lib/auth"
    - from: "dashboard/lib/auth.ts"
      to: "DynamoDB UsersTable"
      via: "QueryCommand with EmailIndex"
      pattern: "IndexName.*EmailIndex"
---

<objective>
Create Next.js 15 dashboard application with Auth.js v5 authentication and base layout.

Purpose: Establish the foundation for all dashboard features - authentication ensures only authorized users can manage sites, and the layout provides consistent navigation.

Output: Working dashboard at /dashboard with login protection, sidebar navigation, and DynamoDB-backed user authentication.
</objective>

<execution_context>
@/Users/myownip/.config/claude/get-shit-done/workflows/execute-plan.md
@/Users/myownip/.config/claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dashboard-observability/03-RESEARCH.md
@infra/stacks/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Next.js 15 Dashboard with shadcn/ui</name>
  <files>
    dashboard/package.json
    dashboard/tsconfig.json
    dashboard/tailwind.config.ts
    dashboard/app/layout.tsx
    dashboard/app/globals.css
    dashboard/lib/utils.ts
    dashboard/components/ui/button.tsx
    dashboard/components/ui/input.tsx
    dashboard/components/ui/card.tsx
    dashboard/components/ui/form.tsx
    dashboard/components/ui/label.tsx
  </files>
  <action>
    1. Create Next.js 15 app in dashboard/ folder:
       ```bash
       cd /Users/myownip/workspace/vercel-clone
       npx create-next-app@latest dashboard --typescript --tailwind --app --no-eslint --no-src-dir
       ```

    2. Install dependencies:
       ```bash
       cd dashboard
       npm install next-auth@beta @aws-sdk/client-dynamodb @aws-sdk/lib-dynamodb bcryptjs zod react-hook-form @hookform/resolvers
       npm install -D @types/bcryptjs
       ```

    3. Initialize shadcn/ui:
       ```bash
       npx shadcn@latest init -d
       npx shadcn@latest add button input card form label
       ```

    4. Update dashboard/app/layout.tsx with basic HTML structure and globals.css import.

    5. Create dashboard/lib/utils.ts with cn() helper if not created by shadcn.
  </action>
  <verify>
    ```bash
    cd /Users/myownip/workspace/vercel-clone/dashboard
    npm run build
    ```
    Build completes without errors.
  </verify>
  <done>Next.js 15 app exists in dashboard/ with shadcn/ui components installed and builds successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Add UsersTable to DynamoDB and Configure Auth.js v5</name>
  <files>
    infra/stacks/database.ts
    dashboard/lib/auth.ts
    dashboard/app/api/auth/[...nextauth]/route.ts
    dashboard/middleware.ts
    dashboard/.env.local
  </files>
  <action>
    1. Add UsersTable to infra/stacks/database.ts:
       ```typescript
       const usersTable = new sst.aws.Dynamo("UsersTable", {
         fields: {
           userId: "string",
           email: "string",
         },
         primaryIndex: { hashKey: "userId" },
         globalIndexes: {
           EmailIndex: { hashKey: "email" },
         },
       });
       ```
       Export usersTable in the return statement.

    2. Create dashboard/lib/auth.ts with Auth.js v5 configuration:
       - Use Credentials provider
       - Query DynamoDB UsersTable by email using EmailIndex GSI
       - Verify password with bcrypt.compare
       - Return user object with id, email, name
       - Configure JWT callback to include userId
       - Configure session callback to expose userId
       - Set pages.signIn to '/login'

    3. Create dashboard/app/api/auth/[...nextauth]/route.ts:
       ```typescript
       import { handlers } from "@/lib/auth";
       export const { GET, POST } = handlers;
       ```

    4. Create dashboard/middleware.ts:
       ```typescript
       import { auth } from "@/lib/auth";
       import { NextResponse } from "next/server";

       export default auth((req) => {
         const isLoginPage = req.nextUrl.pathname === '/login';
         const isAuthRoute = req.nextUrl.pathname.startsWith('/api/auth');

         if (isAuthRoute || isLoginPage) {
           return NextResponse.next();
         }

         if (!req.auth) {
           return NextResponse.redirect(new URL('/login', req.url));
         }
       });

       export const config = {
         matcher: ['/((?!_next/static|_next/image|favicon.ico).*)'],
       };
       ```

    5. Create dashboard/.env.local with placeholders for local development:
       ```
       AUTH_SECRET=generate-with-openssl-rand-base64-32
       AUTH_URL=http://localhost:3000
       AWS_REGION=ap-southeast-1
       USERS_TABLE_NAME=anchor-deploy-dev-UsersTable-xxx
       PROJECTS_TABLE_NAME=anchor-deploy-dev-ProjectsTable-cwdhxuwt
       DEPLOYMENTS_TABLE_NAME=anchor-deploy-dev-DeploymentsTable-sdhkosws
       API_GATEWAY_URL=https://ksha1s4pnc.execute-api.ap-southeast-1.amazonaws.com
       ```

    6. Add Next.js site to sst.config.ts with resource linking:
       ```typescript
       const dashboard = new sst.aws.Nextjs("Dashboard", {
         path: "dashboard",
         link: [
           usersTable,
           projectsTable,
           deploymentsTable,
           domainsTable,
           webhookApi,
         ],
         environment: {
           AUTH_SECRET: process.env.AUTH_SECRET!,
         },
       });
       ```

       This allows the dashboard to access resources via `Resource.ProjectsTable.name` etc.
       For Phase 3, we'll use env vars for simplicity; SST resource linking can be added later.

    IMPORTANT: Use next-auth@beta (v5) API - auth() returns session directly, not NextAuth().
    IMPORTANT: In middleware, check req.auth (not session) for authentication state.
  </action>
  <verify>
    ```bash
    cd /Users/myownip/workspace/vercel-clone
    npx sst dev --stage dev
    # In another terminal:
    cd dashboard && npm run dev
    # Visit http://localhost:3000 - should redirect to /login
    ```
    Unauthenticated access redirects to /login.
  </verify>
  <done>UsersTable exists in DynamoDB, Auth.js v5 configured with credentials provider, middleware protects routes.</done>
</task>

<task type="auto">
  <name>Task 3: Create Login Page and Dashboard Layout</name>
  <files>
    dashboard/app/(auth)/login/page.tsx
    dashboard/app/(auth)/layout.tsx
    dashboard/app/(dashboard)/layout.tsx
    dashboard/app/(dashboard)/page.tsx
    dashboard/components/dashboard/sidebar.tsx
    dashboard/components/dashboard/header.tsx
  </files>
  <action>
    1. Create dashboard/app/(auth)/layout.tsx - minimal layout for auth pages (centered card).

    2. Create dashboard/app/(auth)/login/page.tsx:
       - Form with email and password fields using shadcn/ui components
       - Use react-hook-form with zod validation
       - Call signIn('credentials', { email, password, redirect: true, callbackUrl: '/' })
       - Display error message on failed login
       - Style: centered card with logo/title

    3. Create dashboard/components/dashboard/sidebar.tsx:
       - Navigation links: Sites, Settings
       - Each site will have sub-routes: Deployments, Logs, Metrics, Env, Domains
       - Use Next.js Link component
       - Highlight active route
       - Width: 256px fixed

    4. Create dashboard/components/dashboard/header.tsx:
       - Show user email from session
       - Sign out button (calls signOut())
       - Dark/light mode toggle (optional, can be placeholder)

    5. Create dashboard/app/(dashboard)/layout.tsx:
       - Get session with auth()
       - Flex layout: sidebar (fixed 256px) + main content (flex-1)
       - Import and render Sidebar and Header components

    6. Create dashboard/app/(dashboard)/page.tsx:
       - Placeholder: "Welcome to Anchor Deploy" with link to /sites
       - Will be replaced by sites list in Plan 02
  </action>
  <verify>
    1. Visit http://localhost:3000 - redirects to /login
    2. Log in with valid credentials (manually insert test user in DynamoDB first)
    3. After login, see dashboard layout with sidebar
    4. Click sign out - returns to /login
  </verify>
  <done>Login page works with credentials, dashboard layout shows sidebar and header, sign out works.</done>
</task>

</tasks>

<verification>
1. Run `cd dashboard && npm run build` - builds without errors
2. Run `cd dashboard && npm run dev` - starts dev server
3. Access http://localhost:3000 - redirects to /login
4. Create test user in DynamoDB UsersTable with hashed password
5. Log in - redirected to dashboard with sidebar visible
6. Protected routes inaccessible without login
7. Sign out works and returns to /login
</verification>

<success_criteria>
- Next.js 15 dashboard app in dashboard/ folder
- Auth.js v5 with DynamoDB credentials provider
- UsersTable with EmailIndex GSI in DynamoDB
- Login page at /login with email/password form
- Middleware redirects unauthenticated users to /login
- Dashboard layout with sidebar (Sites, Settings) and header (user info, sign out)
- Protected routes only accessible after authentication
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard-observability/03-01-SUMMARY.md`
</output>
