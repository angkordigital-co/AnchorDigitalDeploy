---
phase: 02-deployment-cdn
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/deployment.ts
  - packages/core/schemas/deployment.ts
  - packages/core/db/deployments.ts
  - sst.config.ts
autonomous: true

must_haves:
  truths:
    - "CloudFront distribution exists and serves requests"
    - "Server Lambda function handles SSR and API routes"
    - "Static assets serve from S3 via CloudFront"
    - "Deployment records include Lambda version ARNs"
  artifacts:
    - path: "infra/deployment.ts"
      provides: "CloudFront, Lambda, S3 origin infrastructure"
      exports: ["distribution", "serverFunction", "imageFunction", "assetsBucket"]
    - path: "packages/core/schemas/deployment.ts"
      provides: "Extended deployment schema with version tracking"
      contains: "lambdaVersionArn"
  key_links:
    - from: "infra/deployment.ts"
      to: "sst.config.ts"
      via: "module import and return"
      pattern: "import.*deployment"
    - from: "infra/deployment.ts"
      to: "packages/core/schemas/deployment.ts"
      via: "schema type reference"
      pattern: "DeploymentSchema"
---

<objective>
Create CloudFront distribution with Lambda functions and S3 origins for serving deployed Next.js applications.

Purpose: This is the foundational infrastructure for Phase 2. All deployments will be served through this CloudFront distribution with Lambda handling SSR/API and S3 handling static assets.

Output: Deployed CloudFront distribution, server Lambda, image optimization Lambda, and S3 assets bucket configured with proper cache behaviors.
</objective>

<execution_context>
@/Users/myownip/.config/claude/get-shit-done/workflows/execute-plan.md
@/Users/myownip/.config/claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-deployment-cdn/02-RESEARCH.md

# Existing infrastructure to extend
@infra/database.ts
@infra/storage.ts
@infra/build-pipeline.ts
@sst.config.ts
@packages/core/schemas/deployment.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deployment infrastructure module</name>
  <files>infra/deployment.ts</files>
  <action>
Create new SST infrastructure module for deployment serving:

1. **CloudFront Distribution** using SST Cdn component:
   - Origin 1: S3 bucket for static assets (`/_next/static/*`, `/static/*`)
   - Origin 2: Lambda function URL for server (default behavior)
   - Origin 3: Lambda function URL for image optimization (`/_next/image*`)
   - Cache behaviors per RESEARCH.md patterns
   - Enable HTTPS redirect

2. **Server Lambda Function**:
   - Runtime: nodejs20.x
   - Memory: 512 MB (more CPU for faster cold starts)
   - Timeout: 30 seconds (CloudFront max is 60s)
   - Handler: Will be replaced during deployment with actual OpenNext server
   - Environment: NODE_ENV=production
   - Link to: deploymentsTable (for reading deployment config)

3. **Image Optimization Lambda**:
   - Runtime: nodejs20.x
   - Memory: 1024 MB (Sharp needs memory)
   - Timeout: 30 seconds
   - Handler: Placeholder for OpenNext image handler

4. **Assets S3 Bucket**:
   - Use existing artifactsBucket OR create dedicated staticAssetsBucket
   - Configure CORS for CloudFront origin access

5. **Export resources** for use in other modules:
   - distribution (CloudFront)
   - serverFunction (Lambda)
   - imageFunction (Lambda)
   - staticAssetsBucket (S3)

**Important SST patterns from research:**
- Use `sst.aws.Function` for Lambda with function URL
- Use `sst.aws.Cdn` for CloudFront
- Link DynamoDB tables using `link` array
- Set `streaming: true` on server function for SSR streaming support

**Do NOT:**
- Create ACM certificates yet (handled in Plan 03 for custom domains)
- Configure custom domains yet
- Create the actual OpenNext handlers (Plan 02 handles deployment)
  </action>
  <verify>
Run `npx sst dev` and verify:
- CloudFront distribution URL is output
- Server Lambda function exists
- Image Lambda function exists
- No deployment errors
  </verify>
  <done>
CloudFront distribution deployed with Lambda origins and S3 static asset bucket. Distribution URL accessible (returns placeholder response).
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend deployment schema with version tracking</name>
  <files>packages/core/schemas/deployment.ts, packages/core/db/deployments.ts</files>
  <action>
Update the deployment schema and database functions to support version tracking for rollback:

1. **Extend DeploymentSchema** (packages/core/schemas/deployment.ts):
   Add new fields:
   ```typescript
   // Lambda version ARNs for rollback
   lambdaServerVersionArn: z.string().optional(),
   lambdaImageVersionArn: z.string().optional(),

   // S3 asset location
   staticAssetsPath: z.string().optional(), // s3://bucket/deployments/{id}/assets/

   // CloudFront invalidation tracking
   cloudfrontInvalidationId: z.string().optional(),

   // Deployment timing
   deployedAt: z.number().optional(), // timestamp when deployed to CloudFront

   // Version identifier (DEPLOY-06 requirement)
   version: z.string().optional(), // v{timestamp} or commit SHA short
   ```

2. **Add database functions** (packages/core/db/deployments.ts):
   - `getActiveDeployment(projectId)`: Get the currently active deployment for a project
   - `setDeploymentVersion(deploymentId, versionData)`: Update deployment with Lambda ARNs after deploy
   - `getDeploymentVersions(projectId, limit)`: List recent deployments with version info for rollback UI

3. **Create DomainsTable schema** preparation (for Plan 03):
   Add to packages/core/schemas/domain.ts (new file):
   ```typescript
   export const DomainSchema = z.object({
     domainId: z.string(),
     projectId: z.string(),
     domain: z.string(), // e.g., "mysite.example.com"
     certificateArn: z.string().optional(),
     certificateStatus: z.enum(['pending', 'issued', 'failed']).optional(),
     dnsValidation: z.object({
       name: z.string(),
       value: z.string(),
       type: z.literal('CNAME'),
     }).optional(),
     createdAt: z.number(),
     updatedAt: z.number(),
   });
   ```
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
Deployment schema extended with version tracking fields. Domain schema created for Plan 03. Database functions added for version management.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire deployment infrastructure into SST config</name>
  <files>sst.config.ts</files>
  <action>
Update sst.config.ts to import and export deployment infrastructure:

1. Add import for deployment module:
   ```typescript
   const { distribution, serverFunction, imageFunction, staticAssetsBucket } = await import("./infra/deployment.js");
   ```

2. Add to return object:
   ```typescript
   return {
     // ... existing exports
     cloudfrontUrl: distribution.url,
     cloudfrontDistributionId: distribution.id,
     serverFunctionName: serverFunction.name,
     serverFunctionUrl: serverFunction.url,
     imageFunctionName: imageFunction.name,
     staticAssetsBucket: staticAssetsBucket.name,
   };
   ```

3. Ensure import order is correct:
   - database.ts (tables)
   - storage.ts (buckets)
   - deployment.ts (CloudFront + Lambdas) - NEW
   - build-pipeline.ts (CodeBuild)
   - webhooks.ts (API)
  </action>
  <verify>
Deploy and verify outputs:
```bash
npx sst dev
# Check outputs include cloudfrontUrl
```
  </verify>
  <done>
SST config updated. Running `npx sst dev` outputs CloudFront URL and all new resources.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx sst dev` deploys without errors
2. CloudFront distribution URL is accessible (may return error, but URL works)
3. Server Lambda function exists in AWS console
4. Image Lambda function exists in AWS console
5. TypeScript compiles: `npx tsc --noEmit`
6. Deployment schema includes `lambdaServerVersionArn` field
</verification>

<success_criteria>
- CloudFront distribution deployed and accessible
- Server Lambda (512MB, 30s timeout) exists with function URL
- Image Lambda (1024MB, 30s timeout) exists
- Static assets bucket configured with CloudFront origin access
- Deployment schema extended with version tracking fields
- Domain schema created for custom domain support
- All resources exported from sst.config.ts
</success_criteria>

<output>
After completion, create `.planning/phases/02-deployment-cdn/02-01-SUMMARY.md`
</output>
